const CACHE_CONFIG={CACHE_KEY:'eloso_beers_cache',CACHE_DURATION:60*60*1000,MAX_RETRIES:3,RETRY_DELAY:2000};let beersData=[];let cart=JSON.parse(localStorage.getItem('cart'))||[];let currentFilter='all';const isBeersPage=window.location.pathname.includes('beers.html')||document.querySelector('.beers-page')!==null;function getCachedBeers(){try{const cacheData=localStorage.getItem(CACHE_CONFIG.CACHE_KEY);if(!cacheData)return null;const{data,timestamp}=JSON.parse(cacheData);const now=Date.now();if(now-timestamp<CACHE_CONFIG.CACHE_DURATION){console.log('Usando datos del cache');return data}else{console.log('Cache expirado');localStorage.removeItem(CACHE_CONFIG.CACHE_KEY);return null}}catch(error){console.error('Error leyendo cache:',error);return null}}
function setCachedBeers(data){try{const cacheData={data:data,timestamp:Date.now()};localStorage.setItem(CACHE_CONFIG.CACHE_KEY,JSON.stringify(cacheData));console.log('Datos guardados en cache')}catch(error){console.error('Error guardando en cache:',error)}}
async function fetchWithRetry(url,retries=CACHE_CONFIG.MAX_RETRIES,delay=CACHE_CONFIG.RETRY_DELAY){for(let i=0;i<retries;i++){try{console.log(`Intento ${i + 1} de ${retries}`);const response=await fetch(url);if(!response.ok){throw new Error(`HTTP ${response.status}`)}
return await response.json()}catch(error){console.error(`Error en intento ${i + 1}:`,error);if(i===retries-1){throw error}
if(delay>0){console.log(`Esperando ${delay}ms antes del siguiente intento...`);await new Promise(resolve=>setTimeout(resolve,delay));delay*=2}}}}
function initLazyLoading(){const lazyImages=document.querySelectorAll('img.lazy-load');if('IntersectionObserver' in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;img.src=img.dataset.src;img.onload=function(){img.classList.add('loaded')};img.onerror=function(){this.src='images/products/beers/default.jpg';this.classList.add('loaded')};imageObserver.unobserve(img)}})},{rootMargin:'50px 0px',threshold:0.1});lazyImages.forEach(img=>imageObserver.observe(img))}else{lazyImages.forEach(img=>{img.src=img.dataset.src;img.onload=function(){img.classList.add('loaded')};img.onerror=function(){this.src='images/products/beers/default.jpg';this.classList.add('loaded')}})}}
function createImagePlaceholder(width,height){return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${width} ${height}'%3E%3Crect width='${width}' height='${height}' fill='%23111111'/%3E%3C/svg%3E`}
function generateProductSchema(beers){const productSchema=beers.map((beer,index)=>({"@type":"Product","@id":`https://eloso.ar/product/${beer.id}`,"name":beer.name,"description":beer.description,"brand":{"@type":"Brand","name":"El Oso"},"category":beer.subcategory,"sku":`ELOSO-${beer.id}`,"offers":{"@type":"Offer","priceCurrency":"ARS","price":beer.price,"availability":beer.stock>0?"https://schema.org/InStock":"https://schema.org/OutOfStock","url":`https://eloso.ar/beers.html#product-${beer.id}`},"additionalProperty":[{"@type":"PropertyValue","name":"ABV","value":`${beer.abv}%`},{"@type":"PropertyValue","name":"IBU","value":beer.ibu},{"@type":"PropertyValue","name":"Tama√±o","value":beer.size}],"aggregateRating":beer.rating>0?{"@type":"AggregateRating","ratingValue":beer.rating.toFixed(1),"reviewCount":Math.floor(beer.sold/10)}:null})).filter(schema=>schema!==null);const fullSchema={"@context":"https://schema.org","@graph":[{"@type":"Brewery","@id":"https://eloso.ar/#brewery","name":"El Oso","url":"https://eloso.ar/","description":"Cervecer√≠a artesanal especializada en cervezas de monta√±a","address":{"@type":"PostalAddress","addressCountry":"AR","addressRegion":"Buenos Aires"},"servesCuisine":"Cerveza Artesanal"},...productSchema]};const script=document.createElement('script');script.type='application/ld+json';script.textContent=JSON.stringify(fullSchema);document.head.appendChild(script)}
async function fetchBeersFromURL(){try{console.log('Solicitando datos desde la URL...');const data=await fetchWithRetry('https://script.google.com/macros/s/AKfycbw8ftCNEw6hJBslOS4hyTNniPefNlA_Zsu5b8EO_NcUJmnGXfnuWJNL5tPUAdMsmt4PCw/exec');console.log('Datos recibidos:',data);let beerArray=data;if(!Array.isArray(data)){const keys=Object.keys(data);for(const key of keys){if(Array.isArray(data[key])){beerArray=data[key];break}}}
if(!Array.isArray(beerArray)){throw new Error('Los datos recibidos no son un array')}
const transformedData=beerArray.map(item=>{let subcategory=item.subcategory||'otros';subcategory=subcategory.toLowerCase();return{id:item.id||0,name:item.name||'',subname:item.subname||'',description:item.description||'',price:parseInt(item.price)||0,category:'beers',subcategory:subcategory,image:item.image||'images/products/beers/default.jpg',stock:parseInt(item.stock)||0,sold:parseInt(item.sold)||0,rating:parseFloat(item.rating)||0,active:!0,abv:parseFloat(item.abv)||0,ibu:parseInt(item.ibu)||0,ingredients:item.ingredients||'',size:item.size||''}});console.log('Cervezas transformadas:',transformedData.length);return transformedData}catch(error){console.error('Error obteniendo datos desde URL:',error);throw error}}
async function loadBeersData(){try{console.log('Cargando datos de cervezas...');const cachedData=getCachedBeers();if(cachedData){beersData=cachedData;if(isBeersPage){renderBeers()}
setTimeout(()=>{console.log('Actualizando datos en segundo plano...');refreshBeersData()},1000);return}
await refreshBeersData()}catch(error){console.error('Error cargando datos de cervezas:',error);if(isBeersPage){const container=document.getElementById('beers-container');if(container){container.innerHTML=`
                    <div class="no-results" style="grid-column: 1 / -1; text-align: center; padding: 4rem 1rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #333; margin-bottom: 1rem;"></i>
                        <h3>Error al cargar las cervezas</h3>
                        <p>${error.message}</p>
                        <p>Por favor, intenta m√°s tarde.</p>
                    </div>
                `}}}}
async function refreshBeersData(){try{console.log('Forzando actualizaci√≥n de datos...');const transformedData=await fetchBeersFromURL();beersData=transformedData;setCachedBeers(transformedData);if(beersData.length>0){generateProductSchema(beersData)}
if(isBeersPage){renderBeers()}}catch(error){console.error('Error actualizando datos:',error)}}
function getStyleName(subcategory){const sub=subcategory.toLowerCase();const capitalizeFirst=(str)=>{return str.charAt(0).toUpperCase()+str.slice(1)};return sub.toUpperCase()}
function renderBeers(){const container=document.getElementById('beers-container');if(!container)return;if(beersData.length===0){container.innerHTML=`
            <div class="loading" style="grid-column: 1 / -1; text-align: center; padding: 4rem 1rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #C9A96E; margin-bottom: 1rem;"></i>
                <p>Cargando cervezas...</p>
            </div>
        `;return}
let filteredBeers=beersData.filter(beer=>{if(currentFilter!=='all'){const filter=currentFilter.toLowerCase();const subcat=beer.subcategory.toLowerCase();const filterMap={'ipa':['ipa'],'negra':['negra'],'roja':['roja'],'trigo':['trigo'],'rubia':['rubia','dorada'],'especial':['especial']};const matches=filterMap[filter]||[filter];return matches.some(match=>subcat.includes(match))}
return!0});filteredBeers.sort((a,b)=>{if(a.stock===0&&b.stock>0)return 1;if(a.stock>0&&b.stock===0)return-1;return b.sold-a.sold});if(filteredBeers.length===0){container.innerHTML=`
            <div class="no-results" style="grid-column: 1 / -1; text-align: center; padding: 4rem 1rem;">
                <i class="fas fa-beer" style="font-size: 3rem; color: #333; margin-bottom: 1rem;"></i>
                <h3>No se encontraron cervezas</h3>
                <p>Intenta con otro filtro.</p>
            </div>
        `;return}
container.innerHTML=filteredBeers.map(beer=>{return `
        <div class="product-card" data-id="${beer.id}" itemscope itemtype="https://schema.org/Product">
            <div class="product-image">
                ${getProductBadge(beer)}
                <!-- Imagen con lazy loading -->
                <img class="lazy-load" 
                     data-src="${beer.image}" 
                     src="${createImagePlaceholder(300, 200)}"
                     alt="${beer.name}" 
                     loading="lazy"
                     width="300"
                     height="200"
                     itemprop="image">
            </div>
            <div class="product-info">
                <div class="product-category" itemprop="category">${beer.subname}</div>
                <h3 class="product-name" itemprop="name">${beer.name}</h3>
                <p class="product-description" itemprop="description">${beer.description}</p>
                
                <div class="product-specs">
                    <div class="spec" itemprop="additionalProperty" itemscope itemtype="https://schema.org/PropertyValue">
                        <i class="fas fa-beer"></i>
                        <span itemprop="value">${beer.abv}%</span> ABV
                    </div>
                    <div class="spec" itemprop="additionalProperty" itemscope itemtype="https://schema.org/PropertyValue">
                        <i class="fas fa-fire"></i>
                        <span itemprop="value">${beer.ibu}</span> IBU
                    </div>
                    <div class="spec" itemprop="additionalProperty" itemscope itemtype="https://schema.org/PropertyValue">
                        <i class="fas fa-wine-bottle"></i>
                        <span itemprop="value">${beer.size}</span>
                    </div>
                </div>
                
                <div class="product-footer" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                    <meta itemprop="priceCurrency" content="ARS">
                    <meta itemprop="availability" content="${beer.stock > 0 ? 'InStock' : 'OutOfStock'}">
                    <div class="product-price" itemprop="price">$${beer.price.toLocaleString('es-AR')}</div>
                    <button class="btn-add-to-cart" 
                            data-id="${beer.id}" 
                            data-name="${beer.name}" 
                            data-subname="${beer.subname}"
                            data-size="${beer.size}"
                            data-price="${beer.price}" 
                            data-image="${beer.image}"
                            ${beer.stock === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        `}).join('');initLazyLoading()}
function getProductBadge(beer){if(beer.stock===0){return'<div class="product-badge">AGOTADO</div>'}else if(beer.stock<5){return'<div class="product-badge">√öLTIMAS</div>'}else if(beer.sold>200){return'<div class="product-badge">POPULAR</div>'}else if(beer.rating>=4.8){return'<div class="product-badge">TOP</div>'}
return''}
function resetFilters(){currentFilter='all';document.querySelectorAll('.filter-btn').forEach(btn=>{btn.classList.remove('active');if(btn.dataset.filter==='all')btn.classList.add('active');});renderBeers()}
function toggleMobileMenu(){const mobileMenu=document.getElementById('mobile-menu');mobileMenu.classList.toggle('active')}
function toggleCart(){const cartOverlay=document.getElementById('cart-overlay');const cartSidebar=document.getElementById('cart-sidebar');cartOverlay.classList.toggle('active');cartSidebar.classList.toggle('active');if(cartSidebar.classList.contains('active')){renderCart()}}
function renderCart(){const cartItems=document.getElementById('cart-items');const cartEmpty=document.getElementById('cart-empty');const cartTotal=document.getElementById('cart-total');if(cart.length===0){cartItems.innerHTML='';cartEmpty.style.display='flex';cartTotal.textContent='$0';return}
cartEmpty.style.display='none';const total=cart.reduce((sum,item)=>sum+(item.price*item.quantity),0);cartTotal.textContent=`$${total.toLocaleString('es-AR')}`;cartItems.innerHTML=cart.map((item,index)=>`
        <div class="cart-item">
            <div class="cart-item-image">
                <!-- Im√°genes del carrito con lazy loading -->
                <img class="lazy-load" 
                     data-src="${item.image}" 
                     src="${createImagePlaceholder(60, 60)}"
                     alt="${item.name}"
                     loading="lazy"
                     width="60"
                     height="60">
            </div>
            <div class="cart-item-info">
                <div class="cart-item-name">${item.name}<br>${item.subname} ${item.size}</div>
                <div class="cart-item-price">$${(item.price * item.quantity).toLocaleString('es-AR')}</div>
            </div>
            <div class="cart-item-actions">
                <div class="cart-item-quantity">
                    <button class="quantity-btn decrease" data-index="${index}">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn increase" data-index="${index}">+</button>
                </div>
                <button class="cart-item-remove" data-index="${index}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');initLazyLoading()}
function updateCartCount(){const totalItems=cart.reduce((sum,item)=>sum+item.quantity,0);document.querySelectorAll('.cart-count').forEach(el=>{el.textContent=totalItems});localStorage.setItem('cart',JSON.stringify(cart))}
function addToCart(id,name,price,image,subname='',size=''){const existingItem=cart.find(item=>item.id===id);if(existingItem){existingItem.quantity+=1}else{cart.push({id:id,name:name,subname:subname,size:size,price:price,image:image,quantity:1})}
updateCartCount();showNotification(`${name} ${subname} a√±adido al carrito`);if(document.getElementById('cart-sidebar').classList.contains('active')){renderCart()}}
function showNotification(message){const notification=document.createElement('div');notification.style.cssText=`
        position: fixed;
        top: 100px;
        right: 20px;
        background-color: #C9A96E;
        color: #000;
        padding: 1rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        z-index: 3000;
        transform: translateX(100%);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;notification.textContent=message;document.body.appendChild(notification);setTimeout(()=>{notification.style.transform='translateX(0)';notification.style.opacity='1'},10);setTimeout(()=>{notification.style.transform='translateX(100%)';notification.style.opacity='0';setTimeout(()=>{document.body.removeChild(notification)},300)},3000)}
function buildWhatsAppOrderMessage(){let message="Hola! üëã\n";message+="Quiero hacer un pedido directo desde la cervecer√≠a üçª\n\n";message+="Te paso el detalle:\n\n";message+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";cart.forEach((item)=>{message+=`‚Ä¢ ${item.name}\n`;message+=`  Cantidad: ${item.quantity}\n`;message+=`  Subtotal: $${(item.price * item.quantity).toLocaleString('es-AR')}\n\n`});const total=cart.reduce((sum,item)=>sum+(item.price*item.quantity),0);message+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";message+=`Total: $${total.toLocaleString('es-AR')}\n\n`;message+="Despu√©s coordinamos entrega y el pago.\n";message+="Gracias!";return message}
function addRefreshButton(){if(window.location.hostname===''){const refreshBtn=document.createElement('button');refreshBtn.innerHTML='üîÑ';refreshBtn.style.cssText=`
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #C9A96E;
            color: black;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10000;
            font-size: 18px;
        `;refreshBtn.title='Actualizar datos';refreshBtn.addEventListener('click',refreshBeersData);document.body.appendChild(refreshBtn)}}
function clearCart(){cart=[];updateCartCount();renderCart();localStorage.removeItem('cart');showNotification('Carrito vaciado')}
document.addEventListener('DOMContentLoaded',function(){loadBeersData();initLazyLoading();addRefreshButton();const menuToggle=document.getElementById('menu-toggle');const menuClose=document.getElementById('menu-close');const mobileMenu=document.getElementById('mobile-menu');if(menuToggle)menuToggle.addEventListener('click',toggleMobileMenu);if(menuClose)menuClose.addEventListener('click',toggleMobileMenu);if(mobileMenu){mobileMenu.addEventListener('click',(e)=>{if(e.target===mobileMenu)toggleMobileMenu();})}
const cartBtn=document.getElementById('cart-btn');const cartClose=document.getElementById('cart-close');const cartOverlay=document.getElementById('cart-overlay');const checkoutBtn=document.getElementById('checkout-btn');if(cartBtn)cartBtn.addEventListener('click',toggleCart);if(cartClose)cartClose.addEventListener('click',toggleCart);if(cartOverlay){cartOverlay.addEventListener('click',toggleCart)}
if(checkoutBtn){checkoutBtn.addEventListener('click',()=>{if(cart.length===0){showNotification('Tu carrito est√° vac√≠o');return}
const whatsappMessage=buildWhatsAppOrderMessage();const phoneNumber='5491123495971';const encodedMessage=encodeURIComponent(whatsappMessage);const whatsappURL=`https://wa.me/${phoneNumber}?text=${encodedMessage}`;clearCart();setTimeout(()=>{window.open(whatsappURL,'_blank')},100);showNotification('Redirigiendo a WhatsApp para completar tu pedido')})}
const cartFloat=document.getElementById('cart-float');if(cartFloat){cartFloat.addEventListener('click',function(e){e.preventDefault();toggleCart()})}
document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',function(){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');currentFilter=this.dataset.filter;if(isBeersPage)renderBeers();})});document.addEventListener('click',function(e){if(e.target.closest('.btn-add-to-cart')){const button=e.target.closest('.btn-add-to-cart');if(button.disabled)return;const id=button.getAttribute('data-id');const name=button.getAttribute('data-name');const price=parseInt(button.getAttribute('data-price'));const image=button.getAttribute('data-image');const subname=button.getAttribute('data-subname')||'';const size=button.getAttribute('data-size')||'';addToCart(id,name,price,image,subname,size)}
if(e.target.closest('.decrease')){const button=e.target.closest('.decrease');const index=parseInt(button.getAttribute('data-index'));if(cart[index].quantity>1){cart[index].quantity-=1}else{cart.splice(index,1)}
updateCartCount();renderCart()}
if(e.target.closest('.increase')){const button=e.target.closest('.increase');const index=parseInt(button.getAttribute('data-index'));cart[index].quantity+=1;updateCartCount();renderCart()}
if(e.target.closest('.cart-item-remove')){const button=e.target.closest('.cart-item-remove');const index=parseInt(button.getAttribute('data-index'));const itemName=cart[index].name;cart.splice(index,1);updateCartCount();renderCart();showNotification(`${itemName} eliminado`)}});document.addEventListener('keydown',function(e){if(e.key==='Escape'){const mobileMenu=document.getElementById('mobile-menu');const cartSidebar=document.getElementById('cart-sidebar');if(mobileMenu&&mobileMenu.classList.contains('active')){toggleMobileMenu()}
if(cartSidebar&&cartSidebar.classList.contains('active')){toggleCart()}}});updateCartCount()})